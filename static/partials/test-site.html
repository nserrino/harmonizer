<!DOCTYPE html>
<html xmlns = "http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src="/static/js/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="/static/js/bundle.js" type="text/javascript"></script>
    <!-- polyfill -->
    <script src="/static/js/node_modules/midi/inc/shim/Base64.js" type="text/javascript"></script>
    <script src="/static/js/node_modules/midi/inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="/static/js/node_modules/midi/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <!-- midi.js package -->
    <script src="/static/js/node_modules/midi/js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="/static/js/node_modules/midi/js/midi/gm.js" type="text/javascript"></script>
    <script src="/static/js/node_modules/midi/js/midi/loader.js" type="text/javascript"></script>
    <script src="/static/js/node_modules/midi/js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="/static/js/node_modules/midi/js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="/static/js/node_modules/midi/js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="/static/js/node_modules/midi/js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="/static/js/node_modules/midi/js/util/dom_request_script.js" type="text/javascript"></script>
</head>
<body>
<script type="text/javascript">
window.onload = function () {
    var SONG_NAME = 'a_hard_days_night_tdc',
        SECONDS_PER_BEAT = 2,
        HARMONY_OCTAVE = 3;

    MIDI.loadPlugin({
        soundfontUrl: "/static/midi-js-soundfonts/FluidR3_GM/",
        instrument: ["acoustic_grand_piano", "acoustic_guitar_nylon"],
        onprogress: function(state, progress) {
            console.log(state, progress);
        },
        onsuccess: function() {
            MIDI.programChange(0, MIDI.GM.byName["acoustic_grand_piano"].number);
            MIDI.programChange(1, MIDI.GM.byName["acoustic_grand_piano"].number);

            $.ajax({
                type: 'get',
                url: '/melody/get_sequence/' + SONG_NAME,
                success: function (melody) {
                    $.ajax({
                        type: 'get',
                        // url: '/harmony/generate_random/' + SONG_NAME,
                        url: '/harmony/generate_from_csv/' + SONG_NAME,
                        success: function (harmonyInfo) {
                            console.log("melody:", melody)
                            console.log("harmony:", harmonyInfo)
                            player.playMelody(melody, SECONDS_PER_BEAT);
                            player.playHarmony(harmonyInfo, SECONDS_PER_BEAT, HARMONY_OCTAVE);
                        },
                        error: function() {
                            console.log(arguments)
                        }
                    })
                }
            });
        }
    });
};
</script>
</body>
</html>
