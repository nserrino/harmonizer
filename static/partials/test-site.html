<!DOCTYPE html>
<html xmlns = "http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src="/static/js/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="/static/js/tonal-bundle.js" type="text/javascript"></script>
    <!-- polyfill -->
    <script src="/static/js/node_modules/midi/inc/shim/Base64.js" type="text/javascript"></script>
    <script src="/static/js/node_modules/midi/inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="/static/js/node_modules/midi/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <!-- midi.js package -->
    <script src="/static/js/node_modules/midi/js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="/static/js/node_modules/midi/js/midi/gm.js" type="text/javascript"></script>
    <script src="/static/js/node_modules/midi/js/midi/loader.js" type="text/javascript"></script>
    <script src="/static/js/node_modules/midi/js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="/static/js/node_modules/midi/js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="/static/js/node_modules/midi/js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="/static/js/node_modules/midi/js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="/static/js/node_modules/midi/js/util/dom_request_script.js" type="text/javascript"></script>
</head>
<body>
<script type="text/javascript">
window.onload = function () {
    MIDI.loadPlugin({
        soundfontUrl: "/static/midi-js-soundfonts/FluidR3_GM/",
        instrument: ["electric_piano_2", "acoustic_guitar_nylon"],
        onprogress: function(state, progress) {
            console.log(state, progress);
        },
        onsuccess: function() {
            var SECONDS_PER_BEAT = 0.5,
                OCTAVE = 3;

            var TONIC_INT_TO_STRING = [
                'C',
                'Db',
                'D',
                'Eb',
                'E',
                'F',
                'Gb',
                'G',
                'Ab',
                'A',
                'Bb',
                'B'
            ];

            var TONIC_STRING_TO_INT = {
                'C': 0,
                'C#': 1,
                'Db': 1,
                'D': 2,
                'D#': 3,
                'Eb': 3,
                'E': 4,
                'F': 5,
                'F#': 6,
                'Gb': 6,
                'G': 7,
                'G#': 8,
                'Ab': 8,
                'A': 9,
                'A#': 10,
                'Bb': 10,
                'B': 11
            };

            MIDI.programChange(0, MIDI.GM.byName["electric_piano_2"].number);
            MIDI.programChange(1, MIDI.GM.byName["acoustic_guitar_nylon"].number);

            var melody = [
                { beat: 0, melody: 0 },
                { beat: 1, melody: 0 },
                { beat: 2, melody: 7 },
                { beat: 3, melody: 7 },
                { beat: 4, melody: 9 },
                { beat: 5, melody: 9 },
                { beat: 6, melody: 7 },
                { beat: 8, melody: 5 },
                { beat: 9, melody: 5 },
                { beat: 10, melody: 4 },
                { beat: 11, melody: 4 },
                { beat: 12, melody: 2 },
                { beat: 13, melody: 2 },
                { beat: 14, melody: 0 }
            ]

            var harmony = [
                { beat: 0, melody: 0, harmony: 'IV' },
                { beat: 2, melody: 7, harmony: 'I' },
                { beat: 4, melody: 9, harmony: 'IV' },
                { beat: 6, melody: 7, harmony: 'I' },
                { beat: 8, melody: 5, harmony: 'IV' },
                { beat: 10, melody: 4, harmony: 'I' },
                { beat: 12, melody: 2, harmony: 'IV' },
                { beat: 14, melody: 0, harmony: 'I' }
            ]

            for (var i = 0; i < melody.length; ++i) {
                var letterKey = 'C',
                    beat = melody[i].beat,
                    melodyNote = melody[i].melody,
                    nextBeat;

                if (i == melody.length - 1) {
                    nextBeat = beat + 2;
                } else {
                    nextBeat = melody[i + 1].beat;
                }

                MIDI.noteOn(0, melodyNote + 60, 100, SECONDS_PER_BEAT * beat + 1);
                MIDI.noteOff(0, melodyNote + 60, SECONDS_PER_BEAT * nextBeat + 1);
            }

            for (var i = 0; i < harmony.length; ++i) {
                var letterKey = 'C',
                    beat = harmony[i].beat,
                    romanNumeral = harmony[i].harmony,
                    nextBeat;

                if (i == harmony.length - 1) {
                    nextBeat = beat + 2;
                } else {
                    nextBeat = harmony[i + 1].beat;
                }

                // Figure out the progression and then play the notes from that chord.
                var progression = tonal.progression.concrete(romanNumeral, letterKey),
                    chord = tonal.chord.notes(progression[0]);

                for (var j = 0; j < chord.length; ++j) {
                    // Make sure to increase the octave up if our root note of the chord is "above" the accompanying notes.
                    var octave = (j > 0 &&
                        TONIC_STRING_TO_INT[chord[0]] > TONIC_STRING_TO_INT[chord[j]]) ?
                        OCTAVE + 1 : OCTAVE,
                        midiNote = tonal.midi.toMidi(chord[j] + octave);

                    MIDI.noteOn(1, midiNote, 100, SECONDS_PER_BEAT * beat + 1);
                    MIDI.noteOff(1, midiNote, SECONDS_PER_BEAT * nextBeat + 1);
                }
            }


            // $.getJSON("a_hard_days_night_tdc.json", function(song) {
            //     for (var i = 0; i < song.length; ++i) {
            //         var romanNumeral = song[i]["Harmony Roman Numeral"],
            //             numericKey = song[i]["Harmony key tonic"],
            //             letterKey = TONIC_INT_TO_STRING[numericKey],
            //             beat = song[i]["Beats"],
            //             melodyNote = song[i]["Melody absolute pitch"],
            //             nextBeat;

            //         if (i == song.length - 1) {
            //             nextBeat = beat + 3;
            //         } else {
            //             nextBeat = song[i + 1]["Beats"];
            //         }

            //         // Play the melody notes
            //         MIDI.noteOn(0, melodyNote, 100, SECONDS_PER_BEAT * beat);
            //         MIDI.noteOff(0, melodyNote, SECONDS_PER_BEAT * nextBeat);

            //         // Figure out the progression and then play the notes from that chord.
            //         var progression = tonal.progression.concrete(romanNumeral, letterKey),
            //             chord = tonal.chord.notes(progression[0]);

            //         for (var j = 0; j < chord.length; ++j) {
            //             // Make sure to increase the octave up if our root note of the chord is "above" the accompanying notes.
            //             var octave = (j > 0 &&
            //                 TONIC_STRING_TO_INT[chord[0]] > TONIC_STRING_TO_INT[chord[j]]) ?
            //                 OCTAVE + 1 : OCTAVE,
            //                 midiNote = tonal.midi.toMidi(chord[j] + octave);

            //             MIDI.noteOn(1, midiNote, 100, SECONDS_PER_BEAT * beat);
            //             MIDI.noteOff(1, midiNote, SECONDS_PER_BEAT * nextBeat);
            //         }
            //     }
            // });
        }
    });
};
</script>
</body>
</html>
