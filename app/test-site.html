<!DOCTYPE html>
<html xmlns = "http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="tonal-bundle.js" type="text/javascript"></script>
    <!-- polyfill -->
    <script src="node_modules/midi/inc/shim/Base64.js" type="text/javascript"></script>
    <script src="node_modules/midi/inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="node_modules/midi/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <!-- midi.js package -->
    <script src="node_modules/midi/js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="node_modules/midi/js/midi/gm.js" type="text/javascript"></script>
    <script src="node_modules/midi/js/midi/loader.js" type="text/javascript"></script>
    <script src="node_modules/midi/js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="node_modules/midi/js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="node_modules/midi/js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="node_modules/midi/js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="node_modules/midi/js/util/dom_request_script.js" type="text/javascript"></script>
</head>
<body>
<script type="text/javascript">
window.onload = function () {
    MIDI.loadPlugin({
        soundfontUrl: "midi-js-soundfonts/FluidR3_GM/",
        instrument: ["electric_piano_2", "acoustic_guitar_nylon"],
        // soundfontUrl: "node_modules/midi/examples/soundfont/",
        // instrument: "acoustic_grand_piano",
        onprogress: function(state, progress) {
            console.log(state, progress);
        },
        onsuccess: function() {
            var SECONDS_PER_BEAT = 2,
                OCTAVE = 3;

            var TONIC_INT_TO_STRING = [
                'C',
                'Db',
                'D',
                'Eb',
                'E',
                'F',
                'Gb',
                'G',
                'Ab',
                'A',
                'Bb',
                'B'
            ];

            var TONIC_STRING_TO_INT = {
                'C': 0,
                'C#': 1,
                'Db': 1,
                'D': 2,
                'D#': 3,
                'Eb': 3,
                'E': 4,
                'F': 5,
                'F#': 6,
                'Gb': 6,
                'G': 7,
                'G#': 8,
                'Ab': 8,
                'A': 9,
                'A#': 10,
                'Bb': 10,
                'B': 11
            };

            // require('bundle.js', function (beep) {
            //   console.log(beep)
            // });

            MIDI.programChange(0, MIDI.GM.byName["electric_piano_2"].number);
            MIDI.programChange(1, MIDI.GM.byName["acoustic_guitar_nylon"].number);

            $.getJSON("my_girl_tdc.json", function(song) {
                for (var i = 0; i < song.length; ++i) {
                    var romanNumeral = song[i]["Harmony Roman Numeral"],
                        numericKey = song[i]["Harmony key tonic"],
                        letterKey = TONIC_INT_TO_STRING[numericKey],
                        beat = song[i]["Beats"];

                    if (i == song.length - 1) {
                        nextBeat = beat + 3;
                    } else {
                        nextBeat = song[i + 1]["Beats"];
                    }

                    var progression = tonal.progression.concrete(romanNumeral, letterKey),
                        chord = tonal.chord.notes(progression[0]);

                    for (var j = 0; j < chord.length; ++j) {
                        var note = chord[j],
                            octaveNote = note + OCTAVE,
                            midiNote = tonal.midi.toMidi(octaveNote);

                        MIDI.noteOn(1, midiNote, 100, SECONDS_PER_BEAT * beat);
                        MIDI.noteOff(1, midiNote, SECONDS_PER_BEAT * nextBeat);
                    }

                    var melodyNote = song[i]["Melody absolute pitch"];

                    MIDI.noteOn(0, melodyNote, 100, SECONDS_PER_BEAT * beat);
                    MIDI.noteOff(0, melodyNote, SECONDS_PER_BEAT * nextBeat);
                }
            });
        }
    });
};
</script>
</body>
</html>
