<!DOCTYPE html>
<html xmlns = "http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <!-- polyfill -->
    <script src="node_modules/midi/inc/shim/Base64.js" type="text/javascript"></script>
    <script src="node_modules/midi/inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="node_modules/midi/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <!-- midi.js package -->
    <script src="node_modules/midi/js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="node_modules/midi/js/midi/gm.js" type="text/javascript"></script>
    <script src="node_modules/midi/js/midi/loader.js" type="text/javascript"></script>
    <script src="node_modules/midi/js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="node_modules/midi/js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="node_modules/midi/js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="node_modules/midi/js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="node_modules/midi/js/util/dom_request_script.js" type="text/javascript"></script>
</head>
<body>
<script type="text/javascript">
window.onload = function () {
    MIDI.loadPlugin({
        soundfontUrl: "midi-js-soundfonts/FluidR3_GM/",
        instrument: ["electric_piano_2", "acoustic_guitar_nylon"],
        // soundfontUrl: "node_modules/midi/examples/soundfont/",
        // instrument: "acoustic_grand_piano",
        onprogress: function(state, progress) {
            console.log(state, progress);
        },
        onsuccess: function() {
            var SECONDS_PER_BEAT = 2,
                HARMONY_OCTAVE_OFFSET = 4 * 12;

            $.getJSON("a_hard_days_night_tdc.json", function(song) {
                MIDI.programChange(0, MIDI.GM.byName["electric_piano_2"].number);
                MIDI.programChange(1, MIDI.GM.byName["acoustic_guitar_nylon"].number);

                for (var i = 0; i < song.length; ++i) {
                    var note = song[i]["Melody absolute pitch"], // the MIDI note
                        beat = song[i]["Beats"],
                        nextBeat;

                    var harmonyNote = song[i]["Harmony absolute root"] + HARMONY_OCTAVE_OFFSET;

                    if (i == song.length - 1) {
                        nextBeat = beat + 3;
                    } else{
                        nextBeat = song[i + 1]["Beats"];
                    }

                    var velocity = 100; // how hard the note hits
                    // play the note
                    MIDI.setVolume(0, 100);
                    MIDI.noteOn(0, note, velocity, SECONDS_PER_BEAT * beat);
                    MIDI.noteOff(0, note, SECONDS_PER_BEAT * nextBeat);

                    MIDI.noteOn(1, harmonyNote, velocity, SECONDS_PER_BEAT * beat);
                    MIDI.noteOff(1, harmonyNote, SECONDS_PER_BEAT * nextBeat);
                }
            });
        }
    });
};
</script>
</body>
</html>
